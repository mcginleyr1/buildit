{% extends "base.html" %}

{% block title %}Run #{{ run.number }} - {{ pipeline.name }} - BuildIt{% endblock %}
{% block nav_pipelines %}bg-zinc-800{% endblock %}

{% block content %}
<div class="space-y-6" hx-ext="ws" ws-connect="/ws">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <div class="flex items-center gap-2 text-sm text-zinc-400 mb-1">
                <a href="/" class="hover:text-zinc-200">Pipelines</a>
                <span>/</span>
                <a href="/pipelines/{{ pipeline.id }}" class="hover:text-zinc-200">{{ pipeline.name }}</a>
                <span>/</span>
            </div>
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-semibold">Run #{{ run.number }}</h1>
                {% if run.status == "succeeded" %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-green-900/50 text-green-400">
                    Passed
                </span>
                {% elif run.status == "failed" %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-red-900/50 text-red-400">
                    Failed
                </span>
                {% elif run.status == "running" %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-blue-900/50 text-blue-400">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse"></span>
                    Running
                </span>
                {% elif run.status == "queued" %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-yellow-900/50 text-yellow-400">
                    Queued
                </span>
                {% endif %}
            </div>
        </div>
        <div class="text-sm text-zinc-400">
            Started {{ run.created_at }}
        </div>
    </div>

    <!-- Stages -->
    <div class="grid grid-cols-4 gap-4">
        {% for stage in stages %}
        <div class="bg-zinc-900 rounded-lg border border-zinc-800 p-4 cursor-pointer hover:border-zinc-700"
             onclick="showStageLog('{{ stage.name }}')">
            <div class="flex items-center justify-between mb-2">
                <span class="font-medium">{{ stage.name }}</span>
                {% if stage.status == "succeeded" %}
                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                {% elif stage.status == "failed" %}
                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                {% elif stage.status == "running" %}
                <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                {% elif stage.status == "pending" %}
                <span class="w-2 h-2 rounded-full bg-zinc-500"></span>
                {% elif stage.status == "skipped" %}
                <span class="w-2 h-2 rounded-full bg-zinc-600"></span>
                {% endif %}
            </div>
            <div class="text-xs text-zinc-500 capitalize">{{ stage.status }}</div>
        </div>
        {% endfor %}
    </div>

    <!-- Logs -->
    <div class="bg-zinc-900 rounded-lg border border-zinc-800 overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b border-zinc-800 bg-zinc-850">
            <h2 class="font-medium">Logs</h2>
            <div class="flex gap-2">
                {% for stage in stages %}
                <button onclick="showStageLog('{{ stage.name }}')"
                        id="tab-{{ stage.name }}"
                        class="stage-tab px-3 py-1 text-sm rounded-md text-zinc-400 hover:text-white hover:bg-zinc-700">
                    {{ stage.name }}
                </button>
                {% endfor %}
            </div>
        </div>
        <div id="log-container" class="p-4 h-96 overflow-y-auto bg-zinc-950 mono text-sm">
            <div class="text-zinc-500">Select a stage to view logs</div>
        </div>
    </div>
</div>

<script>
    let currentStage = null;
    let ws = null;

    function showStageLog(stageName) {
        currentStage = stageName;

        // Update tabs
        document.querySelectorAll('.stage-tab').forEach(tab => {
            tab.classList.remove('bg-zinc-700', 'text-white');
            tab.classList.add('text-zinc-400');
        });
        const activeTab = document.getElementById('tab-' + stageName);
        if (activeTab) {
            activeTab.classList.add('bg-zinc-700', 'text-white');
            activeTab.classList.remove('text-zinc-400');
        }

        // Fetch logs
        fetch('/api/v1/runs/{{ run.id }}/logs?stage=' + stageName)
            .then(r => r.json())
            .then(logs => {
                const container = document.getElementById('log-container');
                if (logs.length === 0) {
                    container.innerHTML = '<div class="text-zinc-500">No logs yet</div>';
                } else {
                    container.innerHTML = logs.map(log =>
                        `<div class="log-line ${log.stream === 'stderr' ? 'text-red-400' : 'text-zinc-300'}">${escapeHtml(log.content)}</div>`
                    ).join('');
                }
                container.scrollTop = container.scrollHeight;
            });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Auto-scroll and subscribe if running
    {% if run.status == "running" %}
    document.addEventListener('htmx:wsAfterMessage', function(event) {
        const data = JSON.parse(event.detail.message);
        if (data.type === 'log_line' && data.stage === currentStage) {
            const container = document.getElementById('log-container');
            const line = document.createElement('div');
            line.className = 'log-line ' + (data.stream === 'stderr' ? 'text-red-400' : 'text-zinc-300');
            line.textContent = data.content;
            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        }
    });
    {% endif %}
</script>
{% endblock %}
